name: Build and Test

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

jobs:
  # Maven Build
  build-maven:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: [ 17, 21 ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version

      - name: Build Core and Plugin (install to local repo)
        run: |
          mvn install -B -N
          mvn install -B -pl proto-wrapper-core,proto-wrapper-maven-plugin
          echo "Verify plugin installed:"
          ls ~/.m2/repository/space/alnovis/proto-wrapper-maven-plugin/1.2.0/

      - name: Run Integration Tests
        working-directory: proto-wrapper-integration-tests
        run: mvn verify -B

      - name: Run Maven Example
        working-directory: examples/maven-example
        run: mvn verify -B

      - name: Upload Maven Plugin Artifact
        if: matrix.java-version == 17 && success()
        uses: actions/upload-artifact@v4
        with:
          name: proto-wrapper-maven-plugin
          path: proto-wrapper-maven-plugin/target/*.jar
          retention-days: 7

      - name: Upload Core Artifact
        if: matrix.java-version == 17 && success()
        uses: actions/upload-artifact@v4
        with:
          name: proto-wrapper-core-maven
          path: proto-wrapper-core/target/*.jar
          retention-days: 7

  # Gradle Build
  build-gradle:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: [ 17, 21 ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build --no-daemon

      - name: Grant execute permission for example gradlew
        run: chmod +x examples/gradle-example/gradlew

      - name: Build Gradle Example
        working-directory: examples/gradle-example
        run: ./gradlew build --no-daemon

      - name: Upload Gradle Plugin Artifact
        if: matrix.java-version == 17 && success()
        uses: actions/upload-artifact@v4
        with:
          name: proto-wrapper-gradle-plugin
          path: proto-wrapper-gradle-plugin/build/libs/*.jar
          retention-days: 7

      - name: Upload Core Artifact (Gradle)
        if: matrix.java-version == 17 && success()
        uses: actions/upload-artifact@v4
        with:
          name: proto-wrapper-core-gradle
          path: proto-wrapper-core/build/libs/*.jar
          retention-days: 7

  # Documentation check
  docs-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check documentation files
        run: |
          echo "Checking documentation files..."
          FILES=(
            "README.md"
            "CHANGELOG.md"
            "RELEASE_NOTES.md"
          )
          MISSING=0
          for file in "${FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "::error::Missing: $file"
              MISSING=$((MISSING + 1))
            else
              echo "âœ“ $file"
            fi
          done
          if [ $MISSING -gt 0 ]; then
            exit 1
          fi
          echo "All documentation files present."
