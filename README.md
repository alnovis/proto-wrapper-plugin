# Proto Wrapper Maven Plugin

[ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ](README.ru.md)

Maven plugin for generating version-agnostic Java wrapper classes from multiple protobuf schema versions.

## Features

- Automatic parsing of `.proto` files via `protoc`
- Merging multiple schema versions into a unified API
- Generation of:
  - Version-agnostic interfaces
  - Abstract base classes (Template Method pattern)
  - Version-specific implementations
  - VersionContext for factory operations
- Automatic detection of equivalent enums (nested vs top-level)
- Type conflict handling between versions (intâ†’Long, incompatible types)
- Supported versions info in Javadoc

## Installation

```bash
cd proto-wrapper-plugin
mvn install
```

## Usage

### Minimal Configuration (Recommended)

Specify `basePackage`, `protoRoot` and proto directories - the plugin will do the rest:

```xml
<plugin>
    <groupId>space.alnovis</groupId>
    <artifactId>proto-wrapper-maven-plugin</artifactId>
    <version>1.0.2-SNAPSHOT</version>
    <configuration>
        <basePackage>com.mycompany.myapp.model</basePackage>
        <protoRoot>${basedir}/src/main/proto</protoRoot>
        <versions>
            <version>
                <protoDir>v1</protoDir>
            </version>
            <version>
                <protoDir>v2</protoDir>
            </version>
        </versions>
    </configuration>
    <executions>
        <execution>
            <goals>
                <goal>generate</goal>
            </goals>
        </execution>
    </executions>
</plugin>
```

Classes will be generated in:
- `com.mycompany.myapp.model.api` - interfaces, enums and abstract classes
- `com.mycompany.myapp.model.v1` - v1 implementations
- `com.mycompany.myapp.model.v2` - v2 implementations

The plugin automatically:
1. Finds all `.proto` files in each directory
2. Invokes `protoc` to generate descriptors
3. Analyzes proto files and creates class mappings
4. Generates all wrapper classes

### Running Generation

```bash
mvn generate-sources
# or
mvn compile
```

### Extended Configuration

```xml
<plugin>
    <groupId>space.alnovis</groupId>
    <artifactId>proto-wrapper-maven-plugin</artifactId>
    <version>1.0.2-SNAPSHOT</version>
    <configuration>
        <!-- Base package for generated classes -->
        <basePackage>com.mycompany.myapp.model</basePackage>

        <!-- Root directory with proto files -->
        <protoRoot>${basedir}/proto</protoRoot>

        <!-- Package pattern for proto classes (generated by protoc) -->
        <protoPackagePattern>com.mycompany.myapp.proto.{version}</protoPackagePattern>

        <!-- Output directory for generated files -->
        <outputDirectory>${project.build.directory}/generated-sources/proto-wrapper</outputDirectory>

        <versions>
            <version>
                <!-- Directory relative to protoRoot -->
                <protoDir>v1</protoDir>
                <!-- Optional: version name (defaults to uppercase of protoDir) -->
                <name>V1</name>
                <!-- Optional: exclude specific proto files -->
                <excludeProtos>
                    <excludeProto>internal.proto</excludeProto>
                    <excludeProto>deprecated.proto</excludeProto>
                </excludeProtos>
            </version>
            <version>
                <protoDir>v2</protoDir>
            </version>
        </versions>
    </configuration>
</plugin>
```

## Generated Code Structure

With `basePackage=com.mycompany.myapp.model`:

```
target/generated-sources/proto-wrapper/
â”œâ”€â”€ com/mycompany/myapp/model/api/
â”‚   â”œâ”€â”€ Money.java                    # Interface
â”‚   â”œâ”€â”€ DateTime.java                 # Interface
â”‚   â”œâ”€â”€ Order.java                    # Interface with nested interfaces
â”‚   â”œâ”€â”€ PaymentTypeEnum.java          # Enum
â”‚   â”œâ”€â”€ VersionContext.java           # Factory interface
â”‚   â””â”€â”€ impl/
â”‚       â”œâ”€â”€ AbstractMoney.java        # Abstract base class
â”‚       â”œâ”€â”€ AbstractDateTime.java
â”‚       â””â”€â”€ AbstractOrder.java
â”œâ”€â”€ com/mycompany/myapp/model/v1/
â”‚   â”œâ”€â”€ MoneyV1.java                  # Implementation
â”‚   â”œâ”€â”€ DateTimeV1.java
â”‚   â”œâ”€â”€ OrderV1.java
â”‚   â””â”€â”€ VersionContextV1.java
â””â”€â”€ com/mycompany/myapp/model/v2/
    â”œâ”€â”€ MoneyV2.java
    â”œâ”€â”€ DateTimeV2.java
    â”œâ”€â”€ OrderV2.java
    â””â”€â”€ VersionContextV2.java
```

## Generated Code Examples

### Interface

```java
/**
 * Version-agnostic interface for Money.
 *
 * <p>Supported in versions: [v1, v2]</p>
 */
public interface Money {
    long getBills();
    int getCoins();

    /** @return Protocol version (e.g., 1, 2) */
    int getWrapperVersion();

    /** Serialize to protobuf bytes. */
    byte[] toBytes();

    /** Convert to a specific version implementation. */
    <T extends Money> T asVersion(Class<T> versionClass);
}
```

### Abstract Class

```java
public abstract class AbstractMoney<PROTO extends Message> implements Money {
    protected final PROTO proto;

    protected AbstractMoney(PROTO proto) {
        this.proto = proto;
    }

    protected abstract long extractBills(PROTO proto);
    protected abstract int extractCoins(PROTO proto);

    @Override
    public final long getBills() {
        return extractBills(proto);
    }

    @Override
    public final int getCoins() {
        return extractCoins(proto);
    }
}
```

### Implementation

```java
public class MoneyV1 extends AbstractMoney<Common.Money> {

    public MoneyV1(Common.Money proto) {
        super(proto);
    }

    @Override
    protected long extractBills(Common.Money proto) {
        return proto.getBills();
    }

    @Override
    protected int extractCoins(Common.Money proto) {
        return proto.getCoins();
    }

    public static MoneyV1 from(Common.Money proto) {
        return new MoneyV1(proto);
    }
}
```

### Enum with Version Info

```java
/**
 * Version-agnostic enum for PaymentTypeEnum.
 *
 * <p>Supported in versions: [v1, v2]</p>
 */
public enum PaymentTypeEnum {
    CASH(0),
    CARD(1),

    /**
     * Present only in versions: [v1]
     */
    CREDIT(2),

    /**
     * Present only in versions: [v1]
     */
    TARE(3),

    MOBILE(4);

    // ...
}
```

### VersionContext

```java
// Get context for version
VersionContext ctx = VersionContext.forVersion(2);

// Wrap proto message
Money money = ctx.wrapMoney(protoMessage);
Order order = ctx.wrapOrder(orderProto);
```

## Configuration Parameters

### Main Parameters

| Parameter | Default | Description |
|-----------|---------|-------------|
| `basePackage` | - | Base package for all generated classes |
| `protoRoot` | - | Root directory with proto files |
| `versions` | (required) | List of version configurations |
| `outputDirectory` | `${project.build.directory}/generated-sources/proto-wrapper` | Output directory for generated files |
| `protoPackagePattern` | `{basePackage}.proto.{version}` | Package pattern for proto classes |
| `generateInterfaces` | `true` | Generate interface files |
| `generateAbstractClasses` | `true` | Generate abstract base classes |
| `generateImplClasses` | `true` | Generate version-specific implementations |
| `generateVersionContext` | `true` | Generate VersionContext factory |
| `includeVersionSuffix` | `true` | Include version suffix in impl class names (MoneyV1 vs Money) |
| `includeMessages` | - | List of message names to include (empty = all) |
| `excludeMessages` | - | List of message names to exclude |

### Version Parameters

| Parameter | Description |
|-----------|-------------|
| `protoDir` | Directory with proto files relative to `protoRoot` |
| `name` | Version name (defaults to uppercase of `protoDir`, e.g., `v1` â†’ `V1`) |
| `excludeProtos` | List of proto files to exclude |

### Computed Packages

When `basePackage` is set, other packages are computed automatically:
- `apiPackage` = `basePackage` + `.api`
- `implPackagePattern` = `basePackage` + `.{version}`

## Handling Version Differences

### Type Conflicts

The plugin automatically handles situations when field types differ between versions:

| Situation | Solution |
|-----------|----------|
| `int` in v1 â†’ `long` in v2 | Uses `long`, v1 applies cast `(long)` |
| `int` in v1 â†’ `enum` in v2 | Uses `int`, enum converts via `getNumber()` |
| Incompatible types (message vs primitive) | Field marked as absent in conflicting version |

### Equivalent Enums

If an enum is defined as nested in one version and top-level in another:

```protobuf
// v1: nested enum
message Product {
  enum TaxTypeEnum { VAT = 100; }
}

// v2: top-level enum (in separate file)
enum TaxTypeEnum { VAT = 100; }
```

The plugin automatically:
1. Detects equivalence by name and values
2. Uses unified top-level enum
3. Removes duplicate nested enum

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Proto Files                              â”‚
â”‚                    v1/*.proto, v2/*.proto                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ProtocExecutor                           â”‚
â”‚            Invokes protoc, generates descriptors            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ProtoAnalyzer                            â”‚
â”‚          Parses descriptors into VersionSchema              â”‚
â”‚          Filters by sourcePrefix (directories)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VersionMerger                            â”‚
â”‚         Merges schemas into unified MergedSchema            â”‚
â”‚         Detects equivalent enums                            â”‚
â”‚         Handles type conflicts                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                GenerationOrchestrator                       â”‚
â”‚         Coordinates all code generators                     â”‚
â”‚         Uses GenerationContext for state                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼               â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Interface    â”‚ â”‚  AbstractClass  â”‚ â”‚    ImplClass    â”‚ â”‚ VersionContext  â”‚
â”‚    Generator    â”‚ â”‚   Generator     â”‚ â”‚   Generator     â”‚ â”‚   Generator     â”‚
â”‚  (BaseGenerator)â”‚ â”‚ (BaseGenerator) â”‚ â”‚ (BaseGenerator) â”‚ â”‚ (BaseGenerator) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚               â”‚               â”‚               â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              TypeResolver + JavaTypeMapping                 â”‚
â”‚         Shared type resolution logic                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    JavaPoet                                 â”‚
â”‚              Generates .java source files                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Components

| Component | Description |
|-----------|-------------|
| `GenerateMojo` | Maven plugin entry point, configuration handling |
| `ProtocExecutor` | Invokes protoc compiler, generates descriptors |
| `ProtoAnalyzer` | Parses protobuf descriptors into model objects |
| `VersionMerger` | Merges multiple version schemas into unified schema |
| `GenerationOrchestrator` | Coordinates all code generation |
| `GenerationContext` | Immutable context for generation (schema, config, version) |
| `TypeResolver` | Resolves Java types from proto types |
| `BaseGenerator` | Abstract base class for all generators |
| `PluginLogger` | Callback-based logging abstraction |

## Limitations

- `oneof` fields are not supported
- `map` fields have basic support
- Complex nested message hierarchies may require manual configuration

## Development

```bash
# Build
mvn clean install

# Run tests
mvn test

# Build without tests
mvn install -DskipTests
```

## Usage Example

```java
// Parse proto message
byte[] protoBytes = ...;
OrderProto.Order protoOrder = OrderProto.Order.parseFrom(protoBytes);

// Determine version and wrap
int version = 2;
VersionContext ctx = VersionContext.forVersion(version);
Order order = ctx.wrapOrder(protoOrder);

// Use version-agnostic API
DateTime dateTime = order.getDateTime();
List<Order.Item> items = order.getItems();
OperationTypeEnum operation = order.getOperation();

// Serialize back to proto
byte[] outputBytes = order.toBytes();
```
